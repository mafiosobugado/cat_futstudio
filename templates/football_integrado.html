<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Football Studio - Sistema Integrado</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="game-container">
        <div class="game-frame">
            <div class="floating-info">
                <div>üéØ <strong>Football Studio Integrado</strong></div>
                <div>üìä Monitoramento: <span id="monitor-status">Aguardando</span></div>
                <div>‚è∞ <span id="last-update">--:--:--</span></div>
            </div>
            
            <iframe 
                id="gameFrame"
                src="https://luck.bet.br/live-casino/game/1384453"
                allow="camera; microphone; encrypted-media; fullscreen"
                allowfullscreen>
            </iframe>
        </div>
        
        <div class="sidebar">
            <div class="logo">
                <img src="{{ url_for('static', filename='logomago.png') }}" alt="Academia do Mago">
                <h3 class="logo-title">Football Studio</h3>
                <p class="logo-subtitle">Jogue e Monitore</p>
            </div>
            
            <div class="status-panel">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span class="status-text" id="statusText">Sistema Aguardando</span>
                </div>
                <div class="status-details" id="statusDetails">
                    Clique em "Iniciar Monitoramento" para come√ßar
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="iniciarMonitoramentoIntegrado()">
                    üéØ Iniciar Monitoramento Real
                </button>
                <button class="btn btn-advanced" onclick="iniciarSistemaAvancado()">
                    üî¨ Sistema Avan√ßado Real
                </button>
                <button class="btn btn-stop" onclick="pararMonitoramento()">
                    ‚èπÔ∏è Parar Sistema
                </button>
                
                <button class="btn btn-test" onclick="testarCaptura()">
                    üì∏ Testar Captura
                </button>
                <button class="btn btn-danger" onclick="limparDados()">
                    üóëÔ∏è Limpar Dados
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRodadas">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-vermelho" id="vitoriasVermelho">0</div>
                    <div class="stat-label">Vermelho</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-azul" id="vitoriasAzul">0</div>
                    <div class="stat-label">Azul</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-empate" id="empates">0</div>
                    <div class="stat-label">Empates</div>
                </div>
            </div>
            
            <div class="recent-games">
                <h4 class="games-title">üéÆ √öltimas Rodadas</h4>
                <div id="recentGamesList">
                    <div class="waiting-message">
                        Aguardando dados...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monitoramentoAtivo = false;
        let statusInterval;
        
        // Fun√ß√£o para monitoramento integrado (mais simples)
        function iniciarMonitoramentoIntegrado() {
            fetch('/iniciar_monitoramento_integrado', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        monitoramentoAtivo = true;
                        atualizarStatus('Monitoramento Ativo', 'Sistema capturando dados', true);
                        iniciarAtualizacaoStatus();
                    } else {
                        alert('‚ùå Erro: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao iniciar monitoramento');
                });
        }
        
        // Fun√ß√£o para sistema avan√ßado
        function iniciarSistemaAvancado() {
            fetch('/iniciar_captura_avancada', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        monitoramentoAtivo = true;
                        atualizarStatus('Sistema Avan√ßado', 'M√∫ltiplas estrat√©gias ativas', true);
                        iniciarAtualizacaoStatus();
                        alert('üî¨ Sistema Avan√ßado Ativado!');
                    } else {
                        alert('‚ùå Erro: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao iniciar sistema avan√ßado');
                });
        }
        
        // Fun√ß√£o para testar captura
        function testarCaptura() {
            fetch('/capturar_teste', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert((data.success ? 'üì∏ ' : '‚ùå ') + data.message);
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao testar captura');
                });
        }

        // =======================================================
        // FUN√á√ÉO ADICIONADA ABAIXO
        // =======================================================
        function limparDados() {
            // Pede confirma√ß√£o ao usu√°rio antes de uma a√ß√£o destrutiva
            if (confirm('Voc√™ tem certeza que deseja limpar todo o hist√≥rico de rodadas? Esta a√ß√£o n√£o pode ser desfeita.')) {
                fetch('/limpar_dados', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            // Atualiza a interface imediatamente para refletir os dados limpos
                            document.getElementById('totalRodadas').textContent = '0';
                            document.getElementById('vitoriasVermelho').textContent = '0';
                            document.getElementById('vitoriasAzul').textContent = '0';
                            document.getElementById('empates').textContent = '0';
                            document.getElementById('recentGamesList').innerHTML = '<div class="waiting-message">Aguardando dados...</div>';
                            document.getElementById('last-update').textContent = 'Dados limpos';
                        } else {
                            alert('‚ùå Erro: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('‚ùå Ocorreu um erro ao tentar limpar os dados.');
                    });
            }
        }

        // Fun√ß√£o para parar monitoramento
        function pararMonitoramento() {
            fetch('/parar_monitoramento', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    monitoramentoAtivo = false;
                    atualizarStatus('Sistema Parado', 'Monitoramento desativado', false);
                    pararAtualizacaoStatus();
                    alert(data.message);
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }
        
        // Atualizar status visual
        function atualizarStatus(titulo, detalhes, ativo) {
            document.getElementById('statusText').textContent = titulo;
            document.getElementById('statusDetails').textContent = detalhes;
            document.getElementById('monitor-status').textContent = ativo ? 'ATIVO' : 'Parado';
            
            const dot = document.getElementById('statusDot');
            if (ativo) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        }
        
        // Iniciar atualiza√ß√£o de status
        function iniciarAtualizacaoStatus() {
            if (statusInterval) clearInterval(statusInterval); // Limpa intervalo anterior se existir
            statusInterval = setInterval(() => {
                fetch('/status_monitor')
                    .then(response => response.json())
                    .then(data => {
                        if (data.stats) {
                            document.getElementById('totalRodadas').textContent = data.stats.total_rodadas || 0;
                            document.getElementById('vitoriasVermelho').textContent = data.stats.vitorias_vermelho || 0;
                            document.getElementById('vitoriasAzul').textContent = data.stats.vitorias_azul || 0;
                            document.getElementById('empates').textContent = data.stats.empates || 0;
                        }
                        
                        if (data.ultimas_rodadas) {
                            atualizarListaRodadas(data.ultimas_rodadas);
                        }
                        
                        if (data.ultima_atividade) {
                            document.getElementById('last-update').textContent = data.timestamp + ' - ' + data.ultima_atividade;
                        }

                        // Se o backend informar que o monitoramento parou, atualiza o frontend
                        if (monitoramentoAtivo && !data.ativo) {
                            pararMonitoramento();
                        }
                    })
                    .catch(error => {
                        console.log('Erro ao atualizar status:', error);
                        pararAtualizacaoStatus(); // Para de tentar se houver erro de rede
                    });
            }, 3000);
        }
        
        // Parar atualiza√ß√£o de status
        function pararAtualizacaoStatus() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        }
        
        // Atualizar lista de rodadas
        function atualizarListaRodadas(rodadas) {
            const lista = document.getElementById('recentGamesList');
            if (!rodadas || rodadas.length === 0) {
                lista.innerHTML = '<div class="waiting-message">Aguardando dados...</div>';
                return;
            }
            
            const html = rodadas.slice(-10).reverse().map(rodada => `
                <div class="game-row">
                    <div class="game-cards">
                        <div class="card-mini card-vermelho">${rodada.carta_vermelha}</div>
                        <div class="card-mini card-azul">${rodada.carta_azul}</div>
                    </div>
                    <div class="result-mini result-${rodada.resultado}">
                        ${rodada.resultado === 'vermelho' ? 'üî¥' : rodada.resultado === 'azul' ? 'üîµ' : 'üü°'}
                    </div>
                </div>
            `).join('');
            
            lista.innerHTML = html;
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Sistema integrado inicializado');
            atualizarStatus('Sistema Carregado', 'Pronto para monitorar', false);
            // Inicia a busca por status para j√° carregar os dados existentes
            iniciarAtualizacaoStatus();
        });
    </script>
</body>
</html>